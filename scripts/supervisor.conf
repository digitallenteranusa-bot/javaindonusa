; =============================================================================
; ISP Billing System - Supervisor Configuration
; =============================================================================
; Copy file ini ke /etc/supervisor/conf.d/billing-worker.conf
;
; Perintah:
;   sudo cp scripts/supervisor.conf /etc/supervisor/conf.d/billing-worker.conf
;   sudo supervisorctl reread
;   sudo supervisorctl update
;   sudo supervisorctl start billing-worker:*
; =============================================================================

[program:billing-worker]
; Nama proses (akan muncul di supervisorctl status)
process_name=%(program_name)s_%(process_num)02d

; Command untuk menjalankan queue worker
; Sesuaikan path /var/www/billing dengan lokasi instalasi Anda
command=php /var/www/billing/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --max-jobs=1000

; Auto start saat supervisor dimulai
autostart=true

; Auto restart jika worker crash
autorestart=true

; Stop semua proses dalam group
stopasgroup=true
killasgroup=true

; User yang menjalankan worker (sesuaikan dengan web server user)
user=www-data

; Jumlah worker processes
; Untuk server kecil: 1-2
; Untuk server medium: 2-4
; Untuk server besar: 4-8
numprocs=2

; Redirect stderr ke stdout
redirect_stderr=true

; File log output
stdout_logfile=/var/www/billing/storage/logs/worker.log

; Rotasi log (max 10 file x 10MB)
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=10

; Waktu tunggu sebelum force kill (detik)
stopwaitsecs=3600

; Environment variables (opsional)
; environment=QUEUE_DRIVER=redis

; =============================================================================
; Worker untuk queue khusus notifications (opsional)
; =============================================================================

[program:billing-notifications]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/billing/artisan queue:work redis --queue=notifications --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/var/www/billing/storage/logs/worker-notifications.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stopwaitsecs=3600

; =============================================================================
; Group configuration
; =============================================================================

[group:billing]
programs=billing-worker,billing-notifications
priority=999
